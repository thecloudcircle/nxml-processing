

<article xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:mml="http://www.w3.org/1998/Math/MathML" article-type="research-article"><?properties open_access?><front><journal-meta><journal-id journal-id-type="nlm-ta">J Appl Crystallogr</journal-id><journal-id journal-id-type="iso-abbrev">J Appl Crystallogr</journal-id><journal-id journal-id-type="publisher-id">J. Appl. Cryst.</journal-id><journal-title-group><journal-title>Journal of Applied Crystallography</journal-title></journal-title-group><issn pub-type="ppub">0021-8898</issn><issn pub-type="epub">1600-5767</issn><publisher><publisher-name>International Union of Crystallography</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="pmid">28656043</article-id><article-id pub-id-type="pmc">5458597</article-id><article-id pub-id-type="publisher-id">vg5068</article-id><article-id pub-id-type="doi">10.1107/S1600576717004708</article-id><article-id pub-id-type="coden">JACGAR</article-id><article-id pub-id-type="pii">S1600576717004708</article-id><article-categories><subj-group subj-group-type="heading"><subject>Computer Programs</subject></subj-group></article-categories><title-group><article-title>Processing two-dimensional X-ray diffraction and small-angle scattering data in <italic>DAWN 2</italic>
</article-title><alt-title>2D-PXRD calibration and processing</alt-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Filik</surname><given-names>J.</given-names></name><xref ref-type="aff" rid="a">a</xref><xref ref-type="corresp" rid="cor">*</xref></contrib><contrib contrib-type="author"><name><surname>Ashton</surname><given-names>A. W.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Chang</surname><given-names>P. C. Y.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Chater</surname><given-names>P. A.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Day</surname><given-names>S. J.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Drakopoulos</surname><given-names>M.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Gerring</surname><given-names>M. W.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Hart</surname><given-names>M. L.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Magdysyuk</surname><given-names>O. V.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Michalik</surname><given-names>S.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Smith</surname><given-names>A.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Tang</surname><given-names>C. C.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Terrill</surname><given-names>N. J.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Wharmby</surname><given-names>M. T.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Wilhelm</surname><given-names>H.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><aff id="a"><label>a</label>Diamond Light Source Ltd, Harwell Science and Innovation Campus, Didcot OX11 0DE, <country>UK</country></aff></contrib-group><author-notes><corresp id="cor">Correspondence e-mail: <email>jacob.filik@diamond.ac.uk</email></corresp></author-notes><pub-date pub-type="collection"><day>01</day><month>6</month><year>2017</year></pub-date><pub-date pub-type="epub"><day>08</day><month>5</month><year>2017</year></pub-date><pub-date pub-type="pmc-release"><day>08</day><month>5</month><year>2017</year></pub-date><!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. --><volume>50</volume><issue>Pt 3</issue><issue-id pub-id-type="publisher-id">j170300</issue-id><fpage>959</fpage><lpage>966</lpage><history><date date-type="received"><day>15</day><month>2</month><year>2017</year></date><date date-type="accepted"><day>26</day><month>3</month><year>2017</year></date></history><permissions><copyright-statement>&#x000a9; J. Filik et al. 2017</copyright-statement><copyright-year>2017</copyright-year><license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0/uk/"><license-p>This is an open-access article distributed under the terms of the Creative Commons Attribution (CC-BY) Licence, which permits unrestricted use, distribution, and reproduction in any medium, provided the original authors and source are cited.</license-p><ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/">http://creativecommons.org/licenses/by/2.0/uk/</ali:license_ref></license></permissions><self-uri xlink:href="https://doi.org/10.1107/S1600576717004708">A full version of this article is available from Crystallography Journals Online.</self-uri><abstract abstract-type="toc"><p>The <italic>Powder Calibration</italic> and <italic>Processing</italic> packages implemented in <italic>DAWN 2</italic> provide an automated diffraction-geometry calibration and data processing environment for two-dimensional diffraction experiments. The customizable processing chains permit the execution of data processing steps to convert raw two-dimensional data into meaningful data and diffractograms. The provenance of the processed data is maintained, which guarantees reproducibility and transparency of the data treatment.</p></abstract><abstract><p>A software package for the calibration and processing of powder X-ray diffraction and small-angle X-ray scattering data is presented. It provides a multitude of data processing and visualization tools as well as a command-line scripting interface for on-the-fly processing and the incorporation of complex data treatment tasks. Customizable processing chains permit the execution of many data processing steps to convert a single image or a batch of raw two-dimensional data into meaningful data and one-dimensional diffractograms. The processed data files contain the full data provenance of each process applied to the data. The calibration routines can run automatically even for high energies and also for large detector tilt angles. Some of the functionalities are highlighted by specific use cases.</p></abstract><kwd-group><kwd>X-ray diffraction</kwd><kwd>data processing</kwd><kwd>computer programs</kwd></kwd-group></article-meta></front><body><sec id="sec1"><label>1.</label><title>Introduction &#x000a0; </title><p>Experiments on powder X-ray diffraction (PXRD) and small-angle X-ray scattering (SAXS) instruments at synchrotron beamlines are becoming ever more automated and consequently produce an increasing amount of raw data. Moreover, modern area detectors can acquire two-dimensional (2D) data sets at frame rates of the order of 1&#x02005;ms, resulting in an overwhelming number of raw images. These circumstances demand an easy-to-use and flexible data processing software package for use both during and after the data collection.</p><p>Among the large number of software packages that can deal with two-dimensional data sets, <italic>Fit2D</italic> (Hammersley <italic>et al.</italic>, 1996<xref ref-type="bibr" rid="bb8"> &#x025b8;</xref>; Hammersley, 2016<xref ref-type="bibr" rid="bb7"> &#x025b8;</xref>) is the most well known. More recent software developments can be proprietary (<italic>Datasqueeze 3.0</italic>; Heiney, 2005<xref ref-type="bibr" rid="bb10"> &#x025b8;</xref>) or open source but written in expensive commercial languages (<italic>Nika</italic>; Ilavsky, 2012<xref ref-type="bibr" rid="bb11"> &#x025b8;</xref>). In contrast to this are open-source developments using freely available languages, primarily Python [<italic>GSAS-II</italic> (Toby &#x00026; Von Dreele, 2013<xref ref-type="bibr" rid="bb21"> &#x025b8;</xref>), <italic>DPDAK</italic> (Benecke <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb3"> &#x025b8;</xref>), <italic>pyFAI</italic> (Ashiotis <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb1"> &#x025b8;</xref>) and <italic>DIOPTAS</italic> (Prescher &#x00026; Prakapenka, 2015<xref ref-type="bibr" rid="bb18"> &#x025b8;</xref>)]. Packages are often targeted at a particular experiment (<italic>DIOPTAS</italic> for PXRD, <italic>DPDAK</italic> for SAXS) and some are based on an extensible architecture (<italic>DPDAK</italic>) to provide flexibility.</p><p>The <italic>Data Analysis Workbench</italic> (<italic>DAWN</italic>) developed at the Diamond Light Source (DLS) originally had a limited ability for processing PXRD or SAXS data (Basham <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb2"> &#x025b8;</xref>). However, <italic>DAWN</italic> has been substantially rewritten, and <italic>DAWN 2</italic> now provides a versatile data analysis platform for additional software developments. The most recently added tools are specific for the automated calibration and the batch processing of 2D-PXRD and SAXS diffraction data. <italic>DAWN 2</italic> is free, open source and available for anyone to analyse two-dimensional scattering data.<xref ref-type="fn" rid="fn1">1</xref>
</p><p>The key points of the calibration and processing packages are (i) a new user interface to build custom data processing pipelines for a step-by-step analysis or a batch processing of the raw data sets; (ii) a command-line version of <italic>DAWN 2</italic> and a scripting interface to the calibration and reduction; (iii) full data provenance of the processed data, <italic>i.e.</italic> the ability to automatically save all processing steps and parameters that are needed to recreate the same output; (iv) standardized and versatile data input and output; and (v) an implementation of a calibration routine which provides accurate values for energy and the detector geometry even for experiments at very high energy (<inline-formula><inline-graphic xlink:href="j-50-00959-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x02005;keV) or large detector tilts.</p><p>Although these features are a relatively recent addition they have already been used for many experiments (<italic>e.g.</italic> Clout <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb5"> &#x025b8;</xref>; Collins <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb6"> &#x025b8;</xref>; Michalik <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb13"> &#x025b8;</xref>; Pethes <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb16"> &#x025b8;</xref>; Pollastri <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb17"> &#x025b8;</xref>; Sanchez-Fernandez <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb19"> &#x025b8;</xref>; Scott <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb20"> &#x025b8;</xref>; Murray <italic>et al.</italic>, 2017<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>). In this article some details of the new calibration routines (&#x000a7;2<xref ref-type="sec" rid="sec2"/>) and the data processing functionality (&#x000a7;3<xref ref-type="sec" rid="sec3"/>) will be presented. Finally, several use cases (&#x000a7;4<xref ref-type="sec" rid="sec4"/>) highlight how some generic features are deployed on different types of experiments.</p></sec><sec id="sec2"><label>2.</label><title>Calibration of the diffraction geometry &#x000a0; </title><p>The geometry of a diffraction experiment using a two-dimensional detector is given by six independent parameters: the distance between the sample and detector, two orthogonal tilt angles of the detector, two orthogonal detector coordinates for the position of the beam centre (which can be inside or outside of the detector surface), and the energy or wavelength of the X-rays. Throughout this paper we will refer to these six parameters as the diffraction geometry.</p><p>A general calibration routine for PXRD and SAXS experiments has to fulfil many different requirements. It has to (i) reliably determine the diffraction geometry, (ii) be able to execute the routine automatically, and (iii) support nonstandard geometries with the beam centre off the detector or a detector at large tilt angles. To meet these different requirements, the <italic>Powder Calibration</italic> perspective in <italic>DAWN</italic> contains separate routines for calibrating the diffraction geometries of PXRD and SAXS experiments with an appropriate calibration sample (see Fig. 1<xref ref-type="fig" rid="fig1"> &#x025b8;</xref>): (i) a fully automatic routine, which uses either a single image or multiple images for standard detector configurations and (ii) a manual routine which is suitable for detector orientations that result in highly elliptical rings or a beam centre outside the detector frame. At the end of either calibration routine, the determined parameters of the diffraction geometry are saved as a standard NeXus file (K&#x000f6;nnecke <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb12"> &#x025b8;</xref>), which also stores the provenance of the calibration, <italic>i.e.</italic> other relevant information such as the used calibration standard and the details of the selected routine.</p><p>The core of the automatic calibration routine implemented in <italic>DAWN</italic> is a non-iterative, algebraic method originally developed by Hart <italic>et al.</italic> (2013<xref ref-type="bibr" rid="bb9"> &#x025b8;</xref>). It uses multiple two-dimensional diffraction patterns of a calibration standard, taken at a precisely known set of increments of the sample-to-detector distance, and determines the calibration geometry from ellipses fitted to all Debye&#x02013;Scherrer rings simultaneously. Alternatively, the routine allows all parameters of the diffraction geometry to be determined from a single two-dimensional diffraction pattern, if sufficient high-angle reflections are present. However, if a precise value for the X-ray energy is already known, for example from a scan through an absorption edge, the routine requires only one two-dimensional diffraction image of a calibration standard at a single distance.</p><p>The calibration routine starts by automatically determining the approximate radius of each ring assuming a position of the direct X-ray beam on the detector. Thus, it is only applicable to small tilt angles of the detector and with the beam centre on the detector. Initially, each ring is matched against an azimuthally integrated pattern. The rings are then located precisely by taking several hundred line profiles across each circumference and fitting a Gaussian peak shape to each of them. This results in a set of points of maximum intensity for each diffraction ring. Fitting an ellipse to each of these sets of points yields ellipse centres and semi-major axes. The output of these fits is then used to determine the parameters of the diffraction geometry. Uncertainty estimates for these parameters can be generated by using this output as input to the least-squares routine that is part of the manual calibration.</p><p>The manual calibration routine is used for detectors at large tilt angles or images that contain only arcs of Debye&#x02013;Scherrer rings. In this case initial guess values for the parameters of the diffraction geometry are required. Then the diffraction rings are calculated and overlaid with the measured diffraction pattern. If the data and the calculated diffraction rings match then the calculated reflection positions are used in the ring-finding routine described above. The points found on each ring are then used in a least-squares optimization routine to determine the parameters of the diffraction geometry and their uncertainties. If the ring-finding routine fails, the initial guess values need to be adjusted before re-running the routine.</p><p>The application of these two cases is exemplified in Fig. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>. A typical powder diffraction pattern that consists of a large number of nearly circular Debye&#x02013;Scherrer rings centred roughly in the middle of an area detector is shown in Fig. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>(<italic>a</italic>). In this case the automatic calibration routine produces the integrated powder pattern of the calibration sample shown as intensity <italic>versus q</italic> in Fig. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>(<italic>b</italic>). It is in excellent agreement [<inline-formula><inline-graphic xlink:href="j-50-00959-efi2.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x02005;&#x000c5;<sup>&#x02212;1</sup>] with the calculated <italic>q</italic> values of the calibrant (vertical dotted lines) over the entire accessible <italic>q</italic> range. The partial, highly elliptical diffraction rings of a calibration sample recorded with a significantly tilted area detector are depicted in Fig. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>(<italic>c</italic>). Here the reduction to a one-dimensional data set requires a manual adjustment of a calculated ring pattern to the partial rings. Once the calculated rings match the measured ones, the calibration routine is able to produce a very good agreement of the observed and calculated <italic>q</italic> values of the calibrant [<inline-formula><inline-graphic xlink:href="j-50-00959-efi3.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x02005;&#x000c5;<sup>&#x02212;1</sup>] as shown in Fig. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>(<italic>d</italic>).</p></sec><sec id="sec3"><label>3.</label><title>Data processing &#x000a0; </title><p>In the <italic>DAWN</italic> data processing framework, each individual data processing step is designed as an individual isolated module. A com&#x000ad;plete processing chain is built from a sequence of these modules. This provides a highly flexible environment to accommodate different demands on the data processing.</p><p>At the architectural level, each module consists of two classes: the operation, which contains the mathematical algorithm, and a model containing the parameters used by the algorithm, <italic>e.g.</italic> the <italic>q</italic> range to integrate over. The latter can be configured by the user. <italic>DAWN</italic> automatically generates a user interface for the model, so no interface development is needed to add a new module. This modular design is a feature of the Java Eclipse RCP framework in which <italic>DAWN 2</italic> is written. It allows new processing steps to be developed and built outside of the <italic>DAWN 2</italic> source code and installed as a new plug-in. In addition, there are modules that allow a processing algorithm for a specific data treatment or new processing steps to be written as a Python script (Appendix <italic>A</italic>
<xref ref-type="app" rid="appa"/>).</p><p>Fig. 3<xref ref-type="fig" rid="fig3"> &#x025b8;</xref> shows a generic processing work flow grouped by the different tasks and the individual modules each task might include. Data are pushed through this processing chain in a pipeline which uses standard <italic>DAWN</italic> file-reading modules (Basham <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb2"> &#x025b8;</xref>) to load the data (Appendix <italic>B</italic>
<xref ref-type="app" rid="appb"/>) and sequentially send the data down the line. As the code for data loading is decoupled from the rest of <italic>DAWN</italic>, new file loaders can easily be added without modifying the core code. Multiple implementations of this pipeline exist for running through the data: in series, parallel, using a <italic>Passerelle</italic> work flow engine (Brockhauser <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb4"> &#x025b8;</xref>) or with a runner for live data processing. The pipeline also maintains the rank of the input data; for example, processing data from a grid scan will produce a three-dimensional data set of integrated data and two-dimensional data sets from any scalars derived from the integrated patterns (see &#x000a7;4.3<xref ref-type="sec" rid="sec4.3"/>).</p><p>The output of the processed files is written as HDF5 files conforming to the NeXus standard. They store the processed data, associated axes and uncertainties, any selected intermediate data (<italic>e.g.</italic> corrected or normalized two-dimensional images), and the provenance of the data processing. Thus, the output files contain details on which data were processed, the processing chain and which parameters were used for the processing modules. This data provenance makes the data treatment transparent and reproducible as the processing chains can be reloaded from the processed data files.</p><p>In <italic>DAWN</italic> a processing chain can be built using the <italic>Processing</italic> perspective (see Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>). The list of files that have been loaded for processing is shown in the <italic>Data Slice</italic> view (Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>
<italic>a</italic>). Files might be individual images or they may be stacks of images, in which case selecting a file from the list causes the first image from that file to be plotted in the <italic>Input</italic> view (Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>
<italic>b</italic>). A sequence of processing steps for the data can be built up in the <italic>Processing</italic> view (Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>
<italic>c</italic>). A process step (module) is added to the processing chain from a drop-down list and its effect on the data is shown immediately in the <italic>Output</italic> view (Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>
<italic>d</italic>).</p><p>Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>(<italic>c</italic>) shows an example of a processing chain for powder diffraction data. The first module imports the <italic>Detector Calibration</italic>, saved from the <italic>Powder Calibration</italic> perspective. Then a <italic>Threshold Mask</italic> is applied to remove any hot or overexposed pixels from the raw data. Depending on the detector used, the <italic>General Detector Error</italic> module infers the error values for the recorded counts of each pixel in the image. These values will be propagated down the chain. Then the <italic>Powder Diffraction Intensity Corrections</italic> apply a solid angle and polarization correction to the raw image. This is followed by a normalization using <italic>Divide</italic>, which divides the raw intensity values by a reference intensity (<italic>e.g.</italic>
<inline-formula><inline-graphic xlink:href="j-50-00959-efi4.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> value). The next operation is a <italic>Cake Remapping</italic>, and its result is shown in the <italic>Output</italic> view and saved into the output file (indicated by <italic>[Save]</italic> in the <italic>Processing</italic> view). However, the result is not passed further down the sequence (indicated by the black arrow). This means that the input data to the <italic>Cake Remapping</italic> module &#x02018;pass through&#x02019; this step without modification to the <italic>Azimuthal Integration</italic>, which eventually reduces the masked, normalized and intensity-corrected two-dimensional diffraction data to a one-dimensional diffractogram. In the last step this diffractogram is exported to a text file. In this example the output NeXus file contains the cake remapped images and the azimuthally integrated data with intensity errors and any axes selected to propagate with the data (<italic>e.g.</italic> temperature or stage coordinates). Once the processing chain is complete, pressing the run button processes all the images in all the files and yields one output NeXus file for each input file. It is also possible to use <italic>DAWN</italic> from the command line and launch the processing chain to process data files without starting the <italic>Processing</italic> perspective.</p><p>When a processing module is selected, such as the <italic>Cake Remapping</italic> in Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>(<italic>c</italic>), editable parameters associated with the operation are shown in the <italic>Model</italic> view (Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>
<italic>e</italic>). For this particular example the number of azimuthal bins was specified, a pixel-splitting algorithm was selected and the diffractogram will be plotted <italic>versus q</italic>. Once the model parameters are selected, clicking back on the <italic>Processing</italic> view updates the data shown in the <italic>Output</italic> view up to (and including) the selected step in the process chain. Using the <italic>Processing</italic> view like this allows the result of each intermediate step applied to any image in the <italic>Data Slice</italic> view to be shown in the <italic>Output</italic> view. If the selected file in the <italic>Data Slice</italic> view contains multiple images, the frame-control panel of the <italic>Data Slice</italic> view permits the user to browse individual images. By flicking through the images in this way, the effect of a module or the result of the entire process chain on each image is visualized in the updated <italic>Output</italic> view. These features make it easy to build long complicated processing chains while still being confident that the intermediate steps are being applied correctly.</p></sec><sec id="sec4"><label>4.</label><title>Use cases &#x000a0; </title><p>In the following we describe how some of the features introduced above are applied to a broad set of experiments at different beamlines at DLS. The benefit of using a processing chain is highlighted by the &#x02018;on-the-fly&#x02019; data reduction, which enables an almost real-time monitoring of a solid-state reaction (beamline I12). The automated calibration and the scripting interface to generate one-dimensional diffractograms is exemplified for experiments carried out at the Long-Duration Experiment (LDE) instrument (beamline I11). Finally, the capability to process two-dimensional maps of SAXS data acquired by grid scans (beamline I22) highlights how the rank of the raw data set is maintained.</p><sec id="sec4.1"><label>4.1.</label><title>Calibration at high energy and on-the-fly data reduction &#x000a0; </title><p>The diffraction angles at high energies are small, <italic>i.e.</italic>
<inline-formula><inline-graphic xlink:href="j-50-00959-efi5.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. This creates an ambiguity when applying Bragg&#x02019;s law to a set of Debye&#x02013;Scherrer rings of different Miller indices when both detector distance and energy are still unknown. The multi-image calibration routine in <italic>DAWN</italic> allows one to overcome this ambiguity and leads to highly accurate and reliable calibration of the diffraction geometry.</p><p>
<italic>In situ</italic> time-resolved powder diffraction experiments at high energies (<inline-formula><inline-graphic xlink:href="j-50-00959-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x02005;keV) are challenging and non-routine measurements which may last only a few seconds or up to several hours, potentially producing thousands of images. During these experiments it is important to be able to judge from processed data whether external experimental parameters need to be changed while the experiment is ongoing. For instance, when monitoring crystallization from solution, the crystalline peaks of the product at the initial stage have low intensities and need to be separated from the strong diffuse background. Processing such diffraction patterns therefore requires a series of tasks which need to be carried out on the fly in an automated manner. Such tasks can comprise masking, dynamic background subtraction, normalization and integration of peak intensities.</p><p>At beamline I12, the processing chain of <italic>DAWN</italic> was used to process a selection of individual images from the detector as the reaction was happening. Once a chain is saved it can be executed <italic>via</italic> the command line to automatically process data on the fly, <italic>i.e.</italic> data that have just been acquired. Integrating a single image from a Pixium detector (with <inline-formula><inline-graphic xlink:href="j-50-00959-efi7.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> pixels) takes less than 100&#x02005;ms, and multiple images can be processed at this speed in parallel, making the total processing time essentially dependent on the number of cores on the machine. Any intermediate step in the processing chain can be viewed through the user interface, allowing changes to the masking or background subtraction to be made dynamically, without having to process all the data again.</p><p>Fig. 5<xref ref-type="fig" rid="fig5"> &#x025b8;</xref>(<italic>a</italic>) shows as an example a set of diffractograms that are the output of a process chain which included a detailed analysis of changes during a solid-state transformation of organic co-crystals. This subset of diffractograms could be easily identified after a peak fitting revealed an obvious change in peak position and full width at half-maximum (FWHM) of a diffraction peak in the region <inline-formula><inline-graphic xlink:href="j-50-00959-efi8.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x000b0; (Fig. 5<xref ref-type="fig" rid="fig5"> &#x025b8;</xref>
<italic>b</italic>). When data collections contain thousands of images the benefit of the automatic execution of a processing chain is obvious. Although the individual tasks are quite simple, without an automatic background subtraction and subsequent basic data processing (including peak fitting) <italic>in situ</italic> and time-resolved investigation of chemical reactions would be much more cumbersome and less efficient.</p></sec><sec id="sec4.2"><label>4.2.</label><title>Automated calibration and data reduction &#x000a0; </title><p>The ability to script the calibration and reduction routines makes it possible to trigger fully automatic calibration and reduction of the two-dimensional diffraction data. This is important for the LDE facility, which at its full potential records hundreds of diffraction images at up to 20 different diffraction geometries during a measuring day (Murray <italic>et al.</italic>, 2017<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>). Thus, the processed data are made automatically available as diffractograms for further structural refinement.</p><p>As an example for the automated conversion of a two-dimensional to a one-dimensional diffraction pattern the aging of initially amorphous calcium silicate (CaSiO<sub>3</sub>), while exposed to atmospheric CO<sub>2</sub>, is shown. Fig. 6<xref ref-type="fig" rid="fig6"> &#x025b8;</xref> displays only a selection of the diffraction patterns that were recorded once a week for more than nine months. The conversion of amorphous CaSiO<sub>3</sub> to crystalline calcium carbonate (CaCO<sub>3</sub>) over time becomes evident by the formation of Bragg peaks identifying two polymorphs of CaCO<sub>3</sub>: calcite and vaterite. The main conversion appears to be complete after eight weeks of exposure; however, the appearance of additional Bragg peaks at week 21 indicates that the material structure is still evolving. Understanding such (slow) processes responsible for the carbonation of calcium silicates is of relevance to the formation of carbonate minerals in astrophysical environments and also has potential applications in the sequestration of industrial CO<sub>2</sub>. More examples to show the effectiveness of the reduction package can be found in the paper by Murray <italic>et al.</italic> (2017<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>).</p></sec><sec id="sec4.3"><label>4.3.</label><title>SAXS grid scans &#x000a0; </title><p>SAXS is a versatile technique, capable of characterizing the shape and structure of partially ordered materials. Aside from carefully chosen intensity corrections (Pauw, 2013<xref ref-type="bibr" rid="bb15"> &#x025b8;</xref>), SAXS experiments can have quite different processing requirements depending on whether it is the macromolecular shape or orientation of the sample that is being studied. A common approach for investigating heterogeneous orientated structures is to perform two-dimensional grid scans and to generate a map representing the strength and direction of the orientation. For two-dimensional detectors the size of the raw data files can be large, and although it is possible to get some indication of the orientation from the raw data, it is a slow and laborious process.</p><p>The raw data for SAXS grid scans of, for example, a bone sample performed at I22 are saved as NeXus files, which allows the dataset dimension to reflect the dimensionality of the scan (in this case a four-dimensional dataset: two-dimensional scans of two-dimensional images). The mineral scatter from a selection of detector images from three regions of the sample which contain strong orientation and one that exhibits no orientation is shown in Fig. 7<xref ref-type="fig" rid="fig7"> &#x025b8;</xref>(<italic>a</italic>). The process chain contained, amongst others, modules to integrate the detector images to intensity <italic>versus</italic> azimuthal angle over the mineral scatter region (Fig. 7<xref ref-type="fig" rid="fig7"> &#x025b8;</xref>
<italic>b</italic>), and then this integrated pattern was used to calculate the metrics describing the orientation of the sample. Fig. 7<xref ref-type="fig" rid="fig7"> &#x025b8;</xref>(<italic>c</italic>) shows a measure of the proportion of X-rays scattered from parts of the sample with orientation relative to the total scatter, <italic>i.e.</italic> a measure of the degree of orientation of the sample. Since the processing maintains the rank of the raw data and propagates axes with the data, the output NeXus files contain these metrics as two-dimensional datasets with the sample stage axes, which allows the SAXS measurements to be related back to the sample.</p></sec></sec><sec id="sec5"><label>5.</label><title>Conclusion &#x000a0; </title><p>A software package for the calibration of the diffraction geometry of experiments using two-dimensional detectors and the processing of two-dimensional data has been described. It provides an accurate and reliable calibration even for high energies and detectors at large tilt angles, as well as the ability to configure processing pipelines for repetitive tasks to be executed automatically. Moreover, the output files maintain the data provenance, which not only gives the ability to reprocess data in a different manner at a later stage but also guarantees transparency of the data treatment. The <italic>DAWN 2</italic> package enables new types of data collection, as highlighted by the automated calibration and processing of long-duration experiments and the &#x02018;on-the-fly&#x02019; data reduction which is highly beneficial for <italic>in situ</italic> time-resolved measurements. Fairly complex processing tasks on large multi-dimensional data sets, generated for example by grid scans in SAXS experiments, are easy to include in the processing pipeline, as are customized processing steps in the form of Python scripts. Owing to its ability to read a wide variety of data formats, data obtained at other facilities or at the home laboratory can be treated as well.</p></sec></body><back><fn-group><fn id="fn1"><label>1</label><p>
<italic>DAWN 2.4.0</italic> is freely available for download from <ext-link ext-link-type="uri" xlink:href="http://dawnsci.org">http://dawnsci.org</ext-link>. It runs on Windows, Linux and MacOS and requires a 64&#x02005;bit processor and a minimum of 1&#x02005;GB available RAM.</p></fn></fn-group><ack><p>We acknowledge many fruitful discussions with the teams of beamlines I11, I12, I15, I15-1, I16, I18 and I22. We are grateful to I16 for providing the diffraction data at the high-tilt angle. G. Williams and A. Clout, University College London, UK, are acknowledged in particular for sharing a part of their data collected at beamline I12 (proposal EE12735), as is S. R. Inamdar, Queen Mary University, UK, for supplying the bone data obtained at beamline I22 (proposal SM10311) as part of her collaboration with R. Serra, University of Alabama, USA.</p></ack><app-group><app id="appa"><label>Appendix A </label><title>Scripting</title><p>In the following an example of a script for calculating a Kratky data set from intensity <italic>versus q</italic> data is given. Although this example is trivial, it exemplifies how straightforward it is to use the rich libraries available in Python to develop and incorporate new processing steps into the processing chain. It shows how the data are automatically pushed into Python and how Python returns them to the processing pipeline.</p><p>
<monospace>import numpy as np</monospace>
</p><p>
<monospace>def run(xaxis,data, **kwargs):</monospace>
</p><p>&#x02005;&#x02005;&#x02005;
<monospace>kratky = np.power(xaxis,2)*data</monospace>
</p><p>&#x02005;&#x02005;&#x02005;
<monospace>script_outputs = {"data" : kratky}</monospace>
</p><p>&#x02005;&#x02005;&#x02005;
<monospace>script_outputs["xaxis"] = xaxis</monospace>
</p><p>
<monospace>&#x02005;&#x02005;&#x02005;return script_outputs</monospace>
</p></app><app id="appb"><label>Appendix B </label><title>Data formats supported by <italic>DAWN</italic>
</title><p>Although the software was built specifically for use with data collected by beamlines at DLS, the features described in this article are available to use on any data format <italic>DAWN</italic> is able to load. Currently supported data formats include HDF5 files (and derived formats such as NeXus, NetCDFv4, Matlab v7.3), Tiff, EDF, Mar (.mar3450, .mccd), CBF and <italic>Fit2D</italic> (.f2d), as well as JPG, PNG and a variety of ASCII formats.</p></app></app-group><ref-list><title>References</title><ref id="bb1"><mixed-citation publication-type="other">Ashiotis, G., Deschildre, A., Nawaz, Z., Wright, J. P., Karkoulis, D., Picca, F. E. &#x00026; Kieffer, J. (2015). <italic>J. Appl. Cryst.</italic>
<bold>48</bold>, 510&#x02013;519.</mixed-citation></ref><ref id="bb2"><mixed-citation publication-type="other">Basham, M. <italic>et al.</italic> (2015). <italic>J. Synchrotron Rad.</italic>
<bold>22</bold>, 853&#x02013;858.</mixed-citation></ref><ref id="bb3"><mixed-citation publication-type="other">Benecke, G., Wagermaier, W., Li, C., Schwartzkopf, M., Flucke, G., Hoerth, R., Zizak, I., Burghammer, M., Metwalli, E., M&#x000fc;ller-Buschbaum, P., Trebbin, M., F&#x000f6;rster, S., Paris, O., Roth, S. V. &#x00026; Fratzl, P. (2014). <italic>J. Appl. Cryst.</italic>
<bold>47</bold>, 1797&#x02013;1803.</mixed-citation></ref><ref id="bb4"><mixed-citation publication-type="other">Brockhauser, S., Svensson, O., Bowler, M. W., Nanao, M., Gordon, E., Leal, R. M. F., Popov, A., Gerring, M., McCarthy, A. A. &#x00026; Gotz, A. (2012). <italic>Acta Cryst.</italic> D<bold>68</bold>, 975&#x02013;984.</mixed-citation></ref><ref id="bb5"><mixed-citation publication-type="other">Clout, A., Buanz, A. B., Prior, T. J., Reinhard, C., Wu, Y., O&#x02019;Hare, D., Williams, G. R. &#x00026; Gaisford, S. (2016). <italic>Anal. Chem.</italic>
<bold>88</bold>, 10111&#x02013;10117.</mixed-citation></ref><ref id="bb6"><mixed-citation publication-type="other">Collins, D. M., Crudden, D. J., Alabort, E., Connolley, T. &#x00026; Reed, R.&#x000a0;C. (2015). <italic>Acta Mater.</italic>
<bold>94</bold>, 244&#x02013;256.</mixed-citation></ref><ref id="bb7"><mixed-citation publication-type="other">Hammersley, A. P. (2016). <italic>J. Appl. Cryst.</italic>
<bold>49</bold>, 646&#x02013;652.</mixed-citation></ref><ref id="bb8"><mixed-citation publication-type="other">Hammersley, A. P., Svensson, S., Hanfland, M., Fitch, A. &#x00026; H&#x000e4;usermann, D. (1996). <italic>High Pressure Res</italic>
<bold>14</bold>, 235&#x02013;248.</mixed-citation></ref><ref id="bb9"><mixed-citation publication-type="other">Hart, M. L., Drakopoulos, M., Reinhard, C. &#x00026; Connolley, T. (2013). <italic>J. Appl. Cryst.</italic>
<bold>46</bold>, 1249&#x02013;1260.</mixed-citation></ref><ref id="bb10"><mixed-citation publication-type="other">Heiney, P. A. (2005). <italic>IUCr Commission on Powder Diffraction Newsletter</italic>, No. 32, pp. 9&#x02013;11.</mixed-citation></ref><ref id="bb11"><mixed-citation publication-type="other">Ilavsky, J. (2012). <italic>J. Appl. Cryst.</italic>
<bold>45</bold>, 324&#x02013;328.</mixed-citation></ref><ref id="bb12"><mixed-citation publication-type="other">K&#x000f6;nnecke, M. <italic>et al.</italic> (2015). <italic>J. Appl. Cryst.</italic>
<bold>48</bold>, 301&#x02013;305.</mixed-citation></ref><ref id="bb13"><mixed-citation publication-type="other">Michalik, S., &#x0010e;uri&#x00161;in, J., Balga, D., Saksl, K., &#x0010e;uri&#x00161;in, M. &#x00026; Drakopoulos, M. (2016). <italic>J. Alloys Compd.</italic>
<bold>687</bold>, 188&#x02013;196.</mixed-citation></ref><ref id="bb14"><mixed-citation publication-type="other">Murray, C. A., Potter, J., Day, S. J., Baker, A. R., Thompson, S. P., Kelly, J., Morris, C. G., Yang, S. &#x00026; Tang, C. C. (2017). <italic>J. Appl. Cryst.</italic>
<bold>50</bold>, 172&#x02013;183.</mixed-citation></ref><ref id="bb15"><mixed-citation publication-type="other">Pauw, B. R. (2013). <italic>J. Phys. Condens. Matter</italic>, <bold>25</bold>, 383201.</mixed-citation></ref><ref id="bb16"><mixed-citation publication-type="other">Pethes, I., Chahal, R., Nazabal, V., Prestipino, C., Trapananti, A., Michalik, S. &#x00026; Jovari, P. (2016). <italic>J. Phys. Chem. B</italic>, <bold>120</bold>, 9204&#x02013;9214.</mixed-citation></ref><ref id="bb17"><mixed-citation publication-type="other">Pollastri, S., Gualtieri, A. F., Vigliaturo, R., Ignatyev, K., Strafella, E., Pugnaloni, A. &#x00026; Croce, A. (2016). <italic>Chemosphere</italic>, <bold>164</bold>, 547&#x02013;557.</mixed-citation></ref><ref id="bb18"><mixed-citation publication-type="other">Prescher, C. &#x00026; Prakapenka, V. B. (2015). <italic>High Pressure Res.</italic>
<bold>35</bold>, 223&#x02013;230.</mixed-citation></ref><ref id="bb19"><mixed-citation publication-type="other">Sanchez-Fernandez, A., Edler, K. J., Arnold, T., Heenan, R. K., Porcar, L., Terrill, N. J., Terry, A. E. &#x00026; Jackson, A. J. (2016). <italic>Phys. Chem. Chem. Phys.</italic>
<bold>18</bold>, 14063&#x02013;14073.</mixed-citation></ref><ref id="bb20"><mixed-citation publication-type="other">Scott, R., Stone, N., Kendall, C., Geraki, K. &#x00026; Rogers, K. (2016). <italic>NPJ Breast Cancer</italic>, <bold>2</bold>, 16029.</mixed-citation></ref><ref id="bb21"><mixed-citation publication-type="other">Toby, B. H. &#x00026; Von Dreele, R. B. (2013). <italic>J. Appl. Cryst.</italic>
<bold>46</bold>, 544&#x02013;549.</mixed-citation></ref></ref-list></back><floats-group><fig id="fig1" orientation="portrait" position="float"><label>Figure 1</label><caption><p>Work flow for obtaining the parameters of the diffraction geometry. After a (set of) two-dimensional calibration image(s) has been loaded and the process has been initialized, the details of the data define how to proceed. Data with almost complete Debye&#x02013;Scherrer rings of low ellipticity are suited for the automated process. Highly elliptical or partial rings require a manual treatment. Ultimately the calibration information is saved and made available for the data processing.</p></caption><graphic xlink:href="j-50-00959-fig1"/></fig><fig id="fig2" orientation="portrait" position="float"><label>Figure 2</label><caption><p>(<italic>a</italic>) Powder pattern of the calibration standard CeO<sub>2</sub> (NIST, SRM674b) recorded at beamline I11 with a Pixium area detector (RF4343, Thales Electron Devices S. A.) using an X-ray energy of 25.5&#x02005;keV. (<italic>b</italic>) The one-dimensional diffractogram, intensity <italic>versus q</italic>, of the azimuthally integrated two-dimensional pattern shown in (<italic>a</italic>). Superimposed are dotted lines which indicate the <italic>q</italic> values of the calibration standard. The inset shows a zoom into the highest-<italic>q</italic> region and highlights the quality of the calibration. (<italic>c</italic>) Powder pattern of Si (NIST, SRM640c) recorded with X-rays of 12&#x02005;keV at beamline I16 with a Pilatus 2M detector (Dectris Ltd) at a tilt angle of 45&#x000b0; degree. The white grid reflects the tiling of the detector. (<italic>d</italic>) The integrated pattern of (<italic>c</italic>) shows that all peak positions are in perfect agreement with the calculated <italic>q</italic> values of Si (dotted lines). This is emphasized by the zoom in to the high-<italic>q</italic> data shown in the inset.</p></caption><graphic xlink:href="j-50-00959-fig2"/></fig><fig id="fig3" orientation="portrait" position="float"><label>Figure 3</label><caption><p>Generic work flow for processing 2D-PXRD and SAXS data. Each task can contain several sub-tasks such as masking, integration, peak fitting and data export. This process chain could contain other or many more tasks.</p></caption><graphic xlink:href="j-50-00959-fig3"/></fig><fig id="fig4" orientation="portrait" position="float"><label>Figure 4</label><caption><p>Screenshot of the <italic>Processing</italic> perspective embedded in <italic>DAWN 2</italic>, showing (<italic>a</italic>) the <italic>Data Slice</italic> view with multiple files loaded for batch processing, (<italic>b</italic>) the raw detector data image in the <italic>Input</italic> view, (<italic>c</italic>) the <italic>Processing</italic> view with several processing steps, (<italic>d</italic>) the <italic>Output</italic> view with the processed input data at the selected position in the processing chain (<italic>Cake Remapping</italic>) and (<italic>e</italic>) the <italic>Model</italic> view of the selected <italic>Cake Remapping</italic> processing step with its configurable parameters.</p></caption><graphic xlink:href="j-50-00959-fig4"/></fig><fig id="fig5" orientation="portrait" position="float"><label>Figure 5</label><caption><p>Real-time monitoring of a solid-state transformation. (<italic>a</italic>) A subset of diffractograms around a temperature-induced crystallization process. Only those diffractograms where the reaction took place are shown [from frame 75 (blue) to frame 105 (red)]. (<italic>b</italic>) The evolution of the peak position and its FWHM over the entire measurements indicate at which frame, <italic>i.e.</italic> temperature, the transformation occurred.</p></caption><graphic xlink:href="j-50-00959-fig5"/></fig><fig id="fig6" orientation="portrait" position="float"><label>Figure 6</label><caption><p>Selected powder patterns showing the evolution of initially amorphous calcium silicate exposed to atmospheric CO<sub>2</sub> over a period of 36 weeks. The main conversion to crystalline calcium carbonate has almost finished by week eight but small changes are still occurring at week 21. Data were collected at <inline-formula><inline-graphic xlink:href="j-50-00959-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x02005;keV. The diffractograms are vertically shifted with respect to the bottom pattern.</p></caption><graphic xlink:href="j-50-00959-fig6"/></fig><fig id="fig7" orientation="portrait" position="float"><label>Figure 7</label><caption><p>(<italic>a</italic>) Sections of four raw SAXS images obtained from a large grid scan across a bone sample. After various corrections have been applied to the raw images, each of them is mapped on azimuthal angle <italic>versus q</italic> cake plots. Then the integration over <italic>q</italic> yields (<italic>b</italic>) the four intensity <italic>versus</italic> azimuthal angle curves. The positions of the peak maxima in each curve reflect the intensity distribution in each of the raw datasets. The integration of all of these curves in the grid scan eventually leads to (<italic>c</italic>) a map that shows the degree of orientation of the scanned area of the sample.</p></caption><graphic xlink:href="j-50-00959-fig7"/></fig></floats-group></article>